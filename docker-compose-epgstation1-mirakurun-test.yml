version: '3.7'
services:
    mirakurun:
        #build:
        #    context: mirakurun
        #    dockerfile: Dockerfile
        container_name: mirakurun
        image: collelog/uo-mirakurun:2.15.2-node14.2.0-alpine-amd64
        networks:
            - container-link
        ports:
            - "40772:40772"
        volumes:
            - /etc/localtime:/etc/localtime:ro
            - ./mirakurun/sock:/var/run/mirakurun
            - ./mirakurun/conf:/usr/local/etc/mirakurun
            - ./mirakurun/db:/usr/local/var/db/mirakurun
        environment:
            NODE_ENV: production
        cap_add:
            - SYS_NICE
            - SYS_ADMIN
        devices:
            - /dev/px4video0:/dev/px4video0
            - /dev/px4video1:/dev/px4video1
            - /dev/px4video2:/dev/px4video2
            - /dev/px4video3:/dev/px4video3
            - /dev/px4video4:/dev/px4video4
            - /dev/px4video5:/dev/px4video5
            - /dev/px4video6:/dev/px4video6
            - /dev/px4video7:/dev/px4video7
            - /dev/bus/usb/00x/0xx             # USB IC card reader
        init: true
        restart: unless-stopped

    mysql:
        #build:
        #    context: mariadb
        #    dockerfile: Dockerfile
        container_name: epgstation-mysql
        image: collelog/uo-epgstation-mariadb:10.4.12-alpine-amd64
        networks:
            - container-link
        ports:
            - '3306:3306'
        volumes:
            - /etc/localtime:/etc/localtime:ro
            - ./mariadb/sock:/var/run/mysqld
            - ./mariadb/db:/var/lib/mysql
            - ./mariadb/init:/docker-entrypoint-initdb.d/
        #network_mode: 'none'
        environment:
            MYSQL_ROOT_PASSWORD: epgstation
        command: --character-set-server=utf8mb4 --collation-server=utf8mb4_bin --performance-schema=false --expire_logs_days=1
        init: true
        restart: unless-stopped

    epgstation:
        #build:
        #    context: epgstation
        #    dockerfile: Dockerfile
        container_name: epgstation
        image: collelog/uo-epgstation:1.6.7-alpine-amd64
        networks:
            - container-link
        ports:
            - '8888:8888'
            - '8889:8889'
        volumes:
            - /etc/localtime:/etc/localtime:ro
            - ./mirakurun/sock:/var/run/mirakurun
            - ./mariadb/sock:/var/run/mysqld
            - ./epgstation/config:/usr/local/EPGStation/config
            - ./epgstation/data:/usr/local/EPGStation/data
            - ./epgstation/thumbnail:/usr/local/EPGStation/thumbnail
            - ./epgstation/logs:/usr/local/EPGStation/logs
            - ./recorded:/usr/local/EPGStation/recorded
        environment:
            NODE_ENV: production
        depends_on:
           - mirakurun
           - mysql
        #user: '1000:1000'
        init: true
        restart: unless-stopped

networks:
    default:
        external:
            name: bridge

    container-link:
        name: tv-recorder
        driver: bridge
